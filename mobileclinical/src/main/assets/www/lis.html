<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,height=device-height,user-scalable=no" />
    <title>检验</title>
    <link rel="Stylesheet" href="content/site.css" />
    <style type="text/css">
        .nav-left { width: 17.5%; height: 100%; float: left; background-color: #EEEEEE; text-align: left; padding-right: 20px; overflow-y: auto; overflow-x: hidden; }
        .nav-menu { height: 5.5em; line-height: 5.5em; FILTER: progid:DXImageTransform.Microsoft.Gradient(gradientType=0,startColorStr=#F9FCFB,endColorStr=#E6E6E7); /*IE 6 7 8*/ background: -ms-linear-gradient(top, #F9FCFB, #E6E6E7); /* IE 10 */ background: -moz-linear-gradient(top,#F9FCFB,#E6E6E7); /*火狐*/ background: -webkit-gradient(linear, 0% 0%, 0% 100%,from(#F9FCFB), to(#E6E6E7)); /*谷歌*/ background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#F9FCFB), to(#E6E6E7)); /* Safari 4-5, Chrome 1-9*/ background: -webkit-linear-gradient(top, #F9FCFB, #E6E6E7); /*Safari5.1 Chrome 10+*/ background: -o-linear-gradient(top, #F9FCFB, #E6E6E7); /*Opera 11.10+*/ border-top: 1px #D3D3D3 solid; border-right: 1px #D3D3D3 solid; border-left: 1px #D3D3D3 solid; cursor: pointer; -webkit-box-shadow: 0 10px 15px #D6DEE6; -moz-box-shadow: 0 10px 15px #D6DEE6; box-shadow: 0 10px 15px #D6DEE6; }
        .menu-last { border-bottom: 1px #D3D3D3 solid; }
        .menu-active-before { border-bottom: 1px #D3D3D3 solid; }
        .nav-menu span { width: 8.86%; background-color: inherit; float: left; height: 100%; }
        .nav-menu div { width: 91.14%; background-color: inherit; height: 100%; color: #555555; font-size: 1.5em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-menu img { vertical-align: middle; }
        /**/
        .nav-menu-active { height: 5.5em; line-height: 5.5em; background-color: #EEEEEE; border-bottom: none; }
        .nav-menu-active span { width: 8.86%; background-color: #1D46FF; float: left; height: 100%; }
        .nav-menu-active div { width: 91.14%; background-color: inherit; height: 100%; color: #1D46FF; font-size: 1.75em; left: -8.86%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-menu-active img { vertical-align: middle; }
        .content { width: 82.5%; height: 100%; float: right; background-color: #FFFFFF; }
        .c-header { height: 7.5em; margin-top: 0.625em; position: relative; top: -100%; }
        .nav-date { height: 4.375em; }
        .nav-date .slide-left { width: 53px; background: url('content/images/slide-l.png') no-repeat center right; height: 100%; float: left; }
        .nav-date .slide-right { width: 53px; background: url('content/images/slide-r.png') no-repeat center left; height: 100%; float: right; }
        .nav-date .nav-list { height: 100%; position: relative; padding-right: 53px; margin-left: 53px; }
        .nav-date .nav-list .nav-inner { width: 100%; overflow-y: hidden; overflow-x: auto; height: 100%; text-align: center; }
        .nav-date-list { list-style-type: none; margin: 0px; padding: 0px; height: 100%; white-space: nowrap; }
        .nav-date-list .item { width: 7.275em; padding: 0px; display: inline-block; }
        .nav-date-list .item .m { color: #555555; font-size: 1.6875em; display: block; cursor: pointer; }
        .nav-date-list .item .y { color: #B6B6B6; font-size: 1.4972em; display: block; cursor: pointer; }
        .nav-date-list .item-on { width: 7.275em; padding: 0px; display: inline-block; }
        .nav-date-list .item-on .m { color: #1D46FF; font-size: 1.9875em; display: block; cursor: pointer; }
        .nav-date-list .item-on .y { color: #1D46FF; font-size: 1.6875em; display: block; cursor: pointer; }
        .tpl-row { display: none !important; }
        .data-row { }
        .s_line { height: 1em; margin-top:10px; border-top: 1px solid #DFDFDF; margin-left: 53px; margin-right: 53px; }
        .data-header { height: 1.5em; }
        .data-header table { width: 100%; padding: 0px 53px 0px 53px; font-size: 1.5em; height: 1.5em; line-height: 1.5em; color: #8A8A8A; }
        .data-container { height: 100%; padding-top: 8.5em; }
        .data-container .data-viewport { overflow-y: auto; height: 100%; margin-left: 53px; margin-right: 53px; }
        .data-view { width: 100%; color: #525252; table-layout: fixed;}
        .c_1 { font-size: 1.62em; text-align: left; border-bottom: 1px #DFDFDF solid; height: 3em; vertical-align: middle; }
        .c_2 { font-size: 1.62em; text-align: center; border-bottom: 1px #DFDFDF solid; vertical-align: middle; }
        .c_3 { font-size: 1.62em; text-align: center; border-bottom: 1px #DFDFDF solid; vertical-align: middle; }
        .c_4 { font-size: 1.62em; text-align: center; border-bottom: 1px #DFDFDF solid; vertical-align: middle; white-space:nowrap;overflow:hidden; text-overflow:ellipsis; }
        .v-low { color: blue; }
        .v-high { color: red; }
    </style>
</head>
<body>
    <div class="clinical-viewport">
        <div class="nav-left">
            <div style="height: 100%; background-color: #FFFFFF;" id="menu-container" class="data-source-binding" data-source="{binding Reports}" data-formater="formater">
                <div class="tpl-row nav-menu {$lastcls}" onclick="menuClick(this,'{$name}');">
                    <span></span>
                    <div>&nbsp;&nbsp;{$name}</div>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="data-container">
                <div class="data-viewport">
                    <table id="detailView" class="data-view data-source-binding" cellpadding="0" cellspacing="0" border="0" data-source="{binding ReportDetail}" data-formater="detailFormater" data-default-rows="7">
                        <colgroup>
                            <col style="width: 25%" />
                            <col style="width: 25%" />
                            <col style="width: 25%" />
                            <col style="width: 25%" />
                        </colgroup>
                        <tr class="tpl-row">
                            <td class="c_1">{$name}</td>
                            <td class="c_2 {$abnormal}">{$result}&nbsp;{$flag}</td>
                            <td class="c_3">{$refer}</td>
                            <td class="c_4">{$unit}</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="c-header">
                <div class="nav-date">
                    <div class="slide-left"></div>
                    <div class="slide-right"></div>
                    <div class="nav-list">
                        <div class="nav-inner">
                            <ul class="nav-date-list data-source-binding" id="list-report-date" data-source="{binding ListDate}" data-formater="formater">
                                <li class="item tpl-row" onclick="onDateClick(this,'{$lb}','{$name}', '{$keys}');">
                                    <span class="m">{$month}</span>
                                    <span class="y">{$year}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="s_line"></div>
                <div class="data-header">
                    <table cellpadding="0" cellspacing="0" border="0">
                        <colgroup>
                            <col style="width: 25%" />
                            <col style="width: 25%" />
                            <col style="width: 25%" />
                            <col style="width: 25%" />
                        </colgroup>
                        <tr>
                            <th style="text-align:left;" id="detail_name">项目</th>
                            <th id="detail_result">结果&nbsp;&nbsp;<img src="content/images/toggle-switch-off.png" style="vertical-align:middle;" onclick="onSwitchClick(this)" /></th>
                            <th id="detail_refer">参考值</th>
                            <th id="detail_unit">单位</th>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="scripts/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="scripts/common.js" type="text/javascript"></script>
    <!--<script src="content/demo/lis-demo.js"></script>-->
    <script type="text/javascript">
        var menuContainer = document.getElementById("menu-container");
        var datelistCtrl = document.getElementById("list-report-date");

        function menuClick(it, lb) {
            var menu_actived = menuContainer["active-menu"];
            if (it == menu_actived) return;
            for (var i = 0; i < menuContainer.children.length; i++) {
                var menu = menuContainer.children[i];

                if (menu == menu_actived) {
                    menu.className = menu.className.replace("nav-menu-active", "nav-menu");
                    if (i > 0) $(menuContainer.children[i - 1]).removeClass("menu-active-before");
                    if (i == menuContainer.children.length - 1) $(menu).addClass("menu-last");
                }
                else if (menu == it) {
                    menuContainer["active-menu"] = it;
                    it.className = it.className.replace("nav-menu", "nav-menu-active");
                    if (i > 0) $(menuContainer.children[i - 1]).addClass("menu-active-before");
                    if (i == menuContainer.children.length - 1) $(it).removeClass("menu-last");
                }
            }
            $ReportName = lb;
            loadReport(lb);
            if (lb == "微生物") {
                $("#detail_name").text("细菌")
                $("#detail_result").text("抗生素")
                $("#detail_refer").text("结果")
                $("#detail_unit").text("用法及用量")
            }
            else {
                $("#detail_name").text("项目")
                $("#detail_result").html('结果&nbsp;&nbsp;<img src="content/images/toggle-switch' + ($only_abnormal ? '' : '-off') + '.png" style="vertical-align:middle;" onclick="onSwitchClick(this)" />');
                $("#detail_refer").text("参考值")
                $("#detail_unit").text("单位")
            }
        }

        function onDateClick(it,lb,name, keys) {
            var focused = datelistCtrl["focused_item"];
            if (focused == it) return;
            if (focused) focused.className = focused.className.replace("item-on", "item");
            it.className = it.className.replace("item", "item-on");
            datelistCtrl["focused_item"] = it;
            datelistCtrl["focused_item_keys"] = keys;
            this.ReportDetail = getReportDetail(lb,name,keys);
            bindingData("detailView");
        }

        function onSwitchClick(sender) {
            var on = !(sender.src.indexOf("off") < 0);
            $only_abnormal = on;
            sender.src = $only_abnormal ? "content/images/toggle-switch.png" : "content/images/toggle-switch-off.png";
            var el = datelistCtrl["focused_item"];
            if (el) datelistCtrl["focused_item"] = undefined;
            $(el).removeClass("item-on").addClass("item").click();
        }
    </script>
    <script type="text/javascript">
        var AllReports = [];
        var $AllDetails = [];
        var Reports = [];
        var ListDate = [];
        var ReportDetail = [];
        var $ReportName = "";
        var $syxh = 0;
        var $yexh = 0;
        var $only_abnormal = false;

        var formater = {
            lastcls: function (rec) {
                if (rec == Reports[Reports.length - 1]) return "menu-last";
                return "";
            }
        };

        var detailFormater = {
            abnormal: function (rec) {
                var v = $.trim(rec.flag);
                return (v == "↑" ? "v-high" : (v == "↓" ? "v-low" : ""));
            }
        };

        function loadData(syxh,yexh) {
            var patient = $App.getData("CURRENT_PATIENT");
            if (syxh > 0 && (!patient || patient.syxh != syxh)) patient = $decode($App.setData("CURRENT_PATIENT", $App.findData("patient", "info", String.format("{\"syxh\":{0},\"yexh\":{1}}", syxh, yexh)).json));

            this.$syxh = patient.syxh;
            this.$yexh = patient.yexh;

            this.AllReports = $App.findData("lis", "rpt-list", String.format("{\"syxh\":{0},\"yexh\":{1}}", $syxh, $yexh));
            if (!$App.isOnline()) this.$AllDetails = $App.findData("lis", "patient-detail", String.format("{\"syxh\":{0},\"yexh\":{1}}", $syxh, $yexh));
            else this.$AllDetails = [];
            this.Reports = [];
            this.ListDate = [];
            this.ReportDetail = [];
            var rpt = {};
            for (var i = 0; i < this.AllReports.length; i++) {
                var r = $decode(this.AllReports[i].json);
                if (!rpt[$.trim(r.name)]) {
                    this.Reports.push(r);
                    rpt[$.trim(r.name)] = true;
                }
            }
            bindingData("menu-container");
            if (this.Reports.length > 0) menuClick(menuContainer.children[0], $.trim(this.Reports[0].name));
        }

        function loadReport(lb) {
            this.ListDate.length = 0;
            var name = $.trim(lb);
            var dt = {};
            var type = "";
            for (var i = 0; i < this.AllReports.length; i++) {
                var r = $decode(this.AllReports[i].json);
                if ($.trim(r.name) != name) continue;
                var datetime = r.submit_date || "";
                var date = datetime.substring(0, 10);
                if (dt[date]) dt[date].push(r.id);
                else dt[date] = [r.id];
                type = r.type;
            }

            for (var p in dt) this.ListDate.push({ keys: dt[p].join(","), year: p.substring(0, 4), month: p.substr(5), lb: type, name: name });

            this.bindingData("list-report-date");

            if (this.ListDate.length > 0) onDateClick(datelistCtrl.children[this.ListDate.length - 1], type, name, this.ListDate[this.ListDate.length - 1].keys);
        }

        function getReportDetail(lb,name,keys) {
            var arr = [];
            var exists = false;
            for (var i = 0; i < $AllDetails.length; i++) {
                var rec = $AllDetails[i];
                var data = (rec.json && $decode(rec.json)) || rec;
                data._mjson = data._mjson || rec.json;
                $AllDetails[i] = data;
                var c = ("," + keys + ",").indexOf("," + data.report_no + ",") > -1;
                if (c && (!$only_abnormal || !!data.flag)) arr.push(data);
                exists = (c || exists);
            }
            if (arr.length > 0 || exists) return arr;

            if ($App.isOnline()) {
                var details = $App.findData("lis", "rpt-detail", String.format("{\"syxh\":{0},\"yexh\":{1},\"lb\":\"{2}\",\"report\":\"{3}\",\"keys\":\"{4}\"}", $syxh, $yexh, lb, name, keys));
                for (var j = 0; j < details.length; j++) {
                    var rec = details[j];
                    var data = (rec.json && $decode(rec.json)) || rec;
                    data._mjson = data._mjson || rec.json;
                    $AllDetails.push(data);
                    arr.push(data);
                }
            }
            return arr;
        }
        //$(document).ready(function () { setTimeout(loadData, 1) });
    </script>
</body>
</html>
